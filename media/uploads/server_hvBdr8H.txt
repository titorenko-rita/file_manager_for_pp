#include <windows.h>
#include <stdio.h>
#include <tchar.h>
#include <locale.h>
#include <iostream>
#include <fcntl.h>
#include <io.h>

#define BUF_SIZE 256

int wmain() {
    // Устанавливаем поддержку UTF-16 в консоли
    _setmode(_fileno(stdout), _O_U16TEXT);
    _setmode(_fileno(stdin), _O_U16TEXT);

    setlocale(LC_ALL, "ru-RU");

    HANDLE hMapFile;
    LPWSTR pBuf;

    hMapFile = CreateFileMappingW(
        INVALID_HANDLE_VALUE,
        NULL,
        PAGE_READWRITE,
        0,
        BUF_SIZE * sizeof(wchar_t),
        L"MySharedMemory");

    if (hMapFile == NULL) {
        wprintf(L"Ошибка CreateFileMapping: %d\n", GetLastError());
        return 1;
    }

    pBuf = (LPWSTR)MapViewOfFile(
        hMapFile,
        FILE_MAP_ALL_ACCESS,
        0,
        0,
        BUF_SIZE * sizeof(wchar_t));

    if (pBuf == NULL) {
        wprintf(L"Ошибка MapViewOfFile: %d\n", GetLastError());
        CloseHandle(hMapFile);
        return 1;
    }

    wcscpy_s(pBuf, BUF_SIZE, L"Введите пароль:");

    STARTUPINFOW si = { sizeof(si) };
    PROCESS_INFORMATION pi;
    LPCWSTR clientPath = L"C:\\Users\\titor\\source\\repos\\pr_03.04\\x64\\Debug\\client.exe";

    if (!CreateProcessW(clientPath, NULL, NULL, NULL, FALSE, 0, NULL, NULL, &si, &pi)) {
        wprintf(L"Ошибка CreateProcess (%d)\n", GetLastError());
        wprintf(L"Путь: %s\n", clientPath);
    }
    else {
        wprintf(L"Клиент запущен.\n");
        WaitForSingleObject(pi.hProcess, INFINITE);
        CloseHandle(pi.hProcess);
        CloseHandle(pi.hThread);

        wprintf(L"Сервер получил: %s\n", pBuf);
    }

    UnmapViewOfFile(pBuf);
    CloseHandle(hMapFile);

    wprintf(L"Сервер завершает работу...\n");
    return 0;
}
